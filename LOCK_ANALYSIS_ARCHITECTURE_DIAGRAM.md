# 锁分析模块架构图

## 1. 整体架构视图

```
┌────────────────────────────────────────────────────────────────────────┐
│                           Client Layer                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │  Web Browser │  │  Mobile App  │  │   API Client │                 │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                 │
│         │                 │                 │                           │
│         └─────────────────┴─────────────────┘                           │
│                            │                                            │
│                         HTTPS/REST                                      │
└────────────────────────────┼──────────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────────┐
│                       API Gateway                                       │
│  ┌─────────────────────────┴──────────────────────────────┐            │
│  │  FastAPI Application                                   │            │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐       │            │
│  │  │ Auth/Rate  │  │ Validation │  │   Cache    │       │            │
│  │  │  Limiting  │  │   Middleware│  │  Middleware│       │            │
│  │  └────────────┘  └────────────┘  └────────────┘       │            │
│  │  ┌────────────────────────────────────────────┐       │            │
│  │  │  /api/v1/lock-analysis/*                   │       │            │
│  │  │  - GET  /dashboard/{db_id}                 │       │            │
│  │  │  - POST /analyze/{db_id}                   │       │            │
│  │  │  - GET  /wait-chains/{db_id}               │       │            │
│  │  │  - GET  /contentions/{db_id}               │       │            │
│  │  └────────────────────────────────────────────┘       │            │
│  └────────────────────────────────────────────────────────┘            │
└────────────────────────────┼──────────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────────┐
│                      Business Service Layer                             │
│  ┌─────────────────────────┴──────────────────────────────┐            │
│  │         LockAnalysisOrchestrator                       │            │
│  │  ┌──────────────────────────────────────────────────┐  │            │
│  │  │  Workflow Coordination & Result Aggregation      │  │            │
│  │  └──────────────────────────────────────────────────┘  │            │
│  └──────────────┬────────────────────┬─────────────────────┘            │
│                 │                    │                                  │
│     ┌───────────┴──────┐   ┌────────┴──────────┐                      │
│     │                  │   │                   │                       │
│  ┌──▼────────────┐  ┌──▼────────────┐  ┌─────▼─────────┐              │
│  │  Data         │  │  Analysis     │  │  Optimization │              │
│  │  Collector    │  │  Engine       │  │  Advisor      │              │
│  │  Facade       │  │               │  │               │              │
│  └───────────────┘  └───────────────┘  └───────────────┘              │
│         │                   │                   │                      │
│         │                   │                   │                      │
│  ┌──────▼───────┐    ┌──────▼──────┐    ┌──────▼──────┐               │
│  │  Collectors  │    │  Analyzers  │    │  Strategies │               │
│  │  ┌─────────┐ │    │  ┌────────┐ │    │  ┌────────┐ │               │
│  │  │PG       │ │    │  │ Wait   │ │    │  │ Index  │ │               │
│  │  │Collector│ │    │  │ Chain  │ │    │  │ Opt    │ │               │
│  │  └─────────┘ │    │  └────────┘ │    │  └────────┘ │               │
│  │  ┌─────────┐ │    │  ┌────────┐ │    │  ┌────────┐ │               │
│  │  │MySQL    │ │    │  │Content │ │    │  │ Query  │ │               │
│  │  │Collector│ │    │  │ ion    │ │    │  │ Opt    │ │               │
│  │  └─────────┘ │    │  └────────┘ │    │  └────────┘ │               │
│  │  ┌─────────┐ │    │  ┌────────┐ │    │  ┌────────┐ │               │
│  │  │OceanBase│ │    │  │ Health │ │    │  │ Config │ │               │
│  │  │Collector│ │    │  │ Scorer │ │    │  │ Opt    │ │               │
│  │  └─────────┘ │    │  └────────┘ │    │  └────────┘ │               │
│  └──────────────┘    └─────────────┘    └─────────────┘               │
└────────────────────────────┼──────────────────────────────────────────┘
                             │
┌────────────────────────────┼──────────────────────────────────────────┐
│                      Data Access Layer                                  │
│  ┌─────────────────────────┴──────────────────────────────┐            │
│  │           Database Connection Pool Manager             │            │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │            │
│  │  │  PG Pool     │  │  MySQL Pool  │  │  OB Pool     │ │            │
│  │  │  (asyncpg)   │  │  (aiomysql)  │  │  (pymysql)   │ │            │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │            │
│  └─────────┼──────────────────┼──────────────────┼─────────┘            │
└────────────┼──────────────────┼──────────────────┼──────────────────────┘
             │                  │                  │
┌────────────┼──────────────────┼──────────────────┼──────────────────────┐
│            │                  │                  │                       │
│  ┌─────────▼────────┐  ┌──────▼──────┐  ┌───────▼────────┐              │
│  │   PostgreSQL     │  │    MySQL    │  │  OceanBase     │              │
│  │   (Target DB)    │  │ (Target DB) │  │  (Target DB)   │              │
│  │  ┌────────────┐  │  │  ┌────────┐ │  │  ┌──────────┐  │              │
│  │  │ pg_locks   │  │  │  │INNODB  │ │  │  │  Locks   │  │              │
│  │  │ pg_stat_   │  │  │  │_LOCKS  │ │  │  │  Tables  │  │              │
│  │  │ activity   │  │  │  │_WAITS  │ │  │  │          │  │              │
│  │  └────────────┘  │  │  └────────┘ │  │  └──────────┘  │              │
│  └──────────────────┘  └─────────────┘  └────────────────┘              │
│                         Target Databases                                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                      Infrastructure Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │    Redis     │  │  TimescaleDB │  │  Message     │                  │
│  │    Cache     │  │  (Time       │  │  Queue       │                  │
│  │              │  │   Series)    │  │  (RabbitMQ)  │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  Prometheus  │  │   Grafana    │  │   ELK Stack  │                  │
│  │  (Metrics)   │  │ (Dashboards) │  │   (Logs)     │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流视图

### 2.1 实时分析流程

```
┌─────────┐      ┌──────────────┐      ┌──────────────┐      ┌──────────┐
│  Client │─────▶│  API Gateway │─────▶│ Orchestrator │─────▶│ Collector│
└─────────┘      └──────────────┘      └──────────────┘      └─────┬────┘
                                                                     │
     ▲                                                               │
     │                                                               ▼
     │                                                        ┌──────────────┐
     │                                                        │  Target DB   │
     │                                                        │  pg_locks    │
     │                                                        │  pg_stat_    │
     │           ┌──────────────┐                            │  activity    │
     │           │  Response    │                            └──────┬───────┘
     │           │  Builder     │                                   │
     └───────────┤              │◀──────────────────────────────────┘
                 └──────▲───────┘
                        │
                 ┌──────┴───────┐
                 │  Analyzers   │
                 │  - WaitChain │
                 │  - Contention│
                 │  - Health    │
                 └──────────────┘

数据流步骤:
1. Client 发起分析请求
2. API Gateway 验证和路由
3. Orchestrator 协调分析流程
4. Collector 采集目标数据库锁信息
5. Analyzers 并行分析数据
6. Response Builder 构建响应
7. 返回分析结果给 Client
```

### 2.2 优化建议生成流程

```
┌──────────────┐
│ Analysis     │
│ Result       │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Optimization │
│ Advisor      │
└──────┬───────┘
       │
       ├──────────────┐
       │              │
       ▼              ▼
┌──────────────┐  ┌──────────────┐
│ Index        │  │ Query        │
│ Strategy     │  │ Strategy     │
└──────┬───────┘  └──────┬───────┘
       │              │
       │              │
       ▼              ▼
┌──────────────────────────┐
│  Priority & Impact       │
│  Scoring                 │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│  SQL Script Generation   │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│  Optimization Advice     │
│  List (Sorted)           │
└──────────────────────────┘

流程说明:
1. 分析结果作为输入
2. 各个策略判断是否适用
3. 适用的策略生成具体建议
4. 计算优先级和影响分数
5. 生成可执行的SQL脚本
6. 返回排序后的建议列表
```

### 2.3 缓存策略流程

```
┌────────────┐
│  Request   │
└─────┬──────┘
      │
      ▼
┌─────────────────┐
│ Check Local     │  ─────────────▶ Hit ──┐
│ Cache (Memory)  │                       │
└─────┬───────────┘                       │
      │ Miss                              │
      ▼                                   │
┌─────────────────┐                       │
│ Check Redis     │  ─────────────▶ Hit ─┤
│ Cache           │                       │
└─────┬───────────┘                       │
      │ Miss                              │
      ▼                                   │
┌─────────────────┐                       │
│ Compute Value   │                       │
│ (Expensive)     │                       │
└─────┬───────────┘                       │
      │                                   │
      ▼                                   │
┌─────────────────┐                       │
│ Store in Redis  │                       │
│ & Local Cache   │                       │
└─────┬───────────┘                       │
      │                                   │
      └───────────────────────────────────┤
                                          │
                                          ▼
                                   ┌─────────────┐
                                   │  Response   │
                                   └─────────────┘

缓存层次:
1. Level 1: Local Memory Cache (TTL: 60s)
   - 最快响应 (<1ms)
   - 进程内共享
   - 容量有限 (1000 items)

2. Level 2: Redis Cache (TTL: 10s-1h)
   - 快速响应 (<5ms)
   - 多进程共享
   - 容量较大

3. Level 3: Compute/Database
   - 最慢 (100-500ms)
   - 只在缓存未命中时执行
```

## 3. 核心组件交互视图

### 3.1 采集器组件交互

```
┌─────────────────────────────────────────────────────────────────┐
│                    ILockDataCollector                            │
│                    (Abstract Interface)                          │
│  + collect_current_locks() -> List[LockSnapshot]                │
│  + collect_wait_chains() -> List[WaitChain]                     │
│  + collect_statistics() -> LockStatistics                       │
│  + health_check() -> bool                                       │
└───────────────────────┬─────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────▼────────┐ ┌────▼──────────┐ ┌─▼──────────────┐
│ PostgreSQL     │ │ MySQL         │ │ OceanBase      │
│ Collector      │ │ Collector     │ │ Collector      │
├────────────────┤ ├───────────────┤ ├────────────────┤
│ - pool         │ │ - pool        │ │ - pool         │
│ - database_id  │ │ - database_id │ │ - database_id  │
│                │ │               │ │ - tenant_id    │
├────────────────┤ ├───────────────┤ ├────────────────┤
│ + _parse_lock()│ │ + _parse_     │ │ + _parse_ob_   │
│ + _build_tree()│ │   innodb()    │ │   lock()       │
│ + _assess_     │ │ + _get_lock_  │ │ + _get_dist_   │
│   severity()   │ │   waits()     │ │   locks()      │
└────────────────┘ └───────────────┘ └────────────────┘
        │               │               │
        └───────────────┴───────────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │  Connection Pool      │
            │  ┌─────────────────┐  │
            │  │  asyncpg Pool   │  │
            │  │  aiomysql Pool  │  │
            │  │  pymysql Pool   │  │
            │  └─────────────────┘  │
            └───────────────────────┘
```

### 3.2 分析器组件交互

```
┌──────────────────────────────────────────────────────────┐
│              LockAnalysisEngine                           │
│  ┌────────────────────────────────────────────┐          │
│  │  analyzers: List[IAnalyzer]                │          │
│  │  + analyze(data) -> AnalysisResult         │          │
│  └────────────────┬───────────────────────────┘          │
└───────────────────┼──────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
┌───────▼─────┐ ┌───▼────────┐ ┌─▼──────────┐
│ WaitChain   │ │ Contention │ │ Health     │
│ Analyzer    │ │ Analyzer   │ │ Scorer     │
├─────────────┤ ├────────────┤ ├────────────┤
│ + analyze() │ │ + analyze()│ │ + analyze()│
│             │ │            │ │            │
│ - detect_   │ │ - identify_│ │ - score_   │
│   cycles()  │ │   hot_spot│ │   wait_time│
│             │ │   s()      │ │            │
│ - calc_     │ │            │ │ - score_   │
│   depth()   │ │ - pattern_ │ │   content  │
│             │ │   recogni- │ │   ion()    │
│ - assess_   │ │   tion()   │ │            │
│   severity()│ │            │ │ - calc_    │
│             │ │            │ │   final()  │
└─────────────┘ └────────────┘ └────────────┘
        │               │           │
        └───────────────┴───────────┘
                        │
                        ▼
              ┌─────────────────┐
              │ AnalysisResult  │
              │ ┌─────────────┐ │
              │ │ health_score│ │
              │ │ wait_chains │ │
              │ │ contentions │ │
              │ │ statistics  │ │
              │ └─────────────┘ │
              └─────────────────┘
```

### 3.3 优化策略组件交互

```
┌──────────────────────────────────────────────────────────┐
│           OptimizationAdvisor                             │
│  ┌────────────────────────────────────────────┐          │
│  │  strategies: Dict[str, IOptimizationStrategy]         │
│  │  + generate_advice(analysis, context)      │          │
│  │    -> List[OptimizationAdvice]             │          │
│  └────────────────┬───────────────────────────┘          │
└───────────────────┼──────────────────────────────────────┘
                    │
        ┌───────────┴───────────┬──────────┐
        │                       │          │
┌───────▼─────┐    ┌────────────▼─┐   ┌───▼────────┐
│ Index       │    │ Query         │   │ Config     │
│ Optimization│    │ Optimization  │   │ Optimization│
│ Strategy    │    │ Strategy      │   │ Strategy   │
├─────────────┤    ├───────────────┤   ├────────────┤
│ + is_appli- │    │ + is_applic-  │   │ + is_appli-│
│   cable()   │    │   able()      │   │   cable()  │
│             │    │               │   │            │
│ + generate()│    │ + generate()  │   │ + generate()│
│             │    │               │   │            │
│ - check_    │    │ - identify_   │   │ - analyze_ │
│   missing_  │    │   slow_       │   │   params() │
│   indexes() │    │   queries()   │   │            │
│             │    │               │   │ - generate_│
│ - generate_ │    │ - suggest_    │   │   config() │
│   index_sql│    │   rewrites()  │   │            │
│             │    │               │   │            │
│ - calc_     │    │ - estimate_   │   │ - validate_│
│   impact()  │    │   improveme-  │   │   changes()│
│             │    │   nt()        │   │            │
└─────────────┘    └───────────────┘   └────────────┘
        │                  │                 │
        └──────────────────┴─────────────────┘
                           │
                           ▼
                ┌──────────────────────┐
                │ OptimizationAdvice   │
                │ ┌──────────────────┐ │
                │ │ advice_id        │ │
                │ │ type             │ │
                │ │ priority         │ │
                │ │ title            │ │
                │ │ description      │ │
                │ │ sql_script       │ │
                │ │ impact_score     │ │
                │ └──────────────────┘ │
                └──────────────────────┘
```

## 4. 部署架构视图

```
┌────────────────────────────────────────────────────────────────┐
│                       Load Balancer (Nginx)                     │
│                      SSL Termination                            │
└────────────────────┬────────────────────┬──────────────────────┘
                     │                    │
         ┌───────────┴───────┐    ┌───────┴──────────┐
         │                   │    │                  │
┌────────▼────────┐  ┌───────▼────────┐  ┌─────────▼──────┐
│  App Instance 1 │  │ App Instance 2 │  │ App Instance N │
│  (Container)    │  │ (Container)    │  │ (Container)    │
│                 │  │                │  │                │
│  FastAPI        │  │  FastAPI       │  │  FastAPI       │
│  + Orchestrator │  │  + Orchestrator│  │  + Orchestrator│
│  + Collectors   │  │  + Collectors  │  │  + Collectors  │
│  + Analyzers    │  │  + Analyzers   │  │  + Analyzers   │
└────────┬────────┘  └────────┬───────┘  └────────┬───────┘
         │                    │                   │
         └────────────────────┴───────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
      ┌───────▼─────┐  ┌──────▼──────┐  ┌────▼────────┐
      │   Redis     │  │ TimescaleDB │  │  RabbitMQ   │
      │   Cluster   │  │  (Metrics)  │  │  (Tasks)    │
      │   (Cache)   │  │             │  │             │
      └─────────────┘  └─────────────┘  └─────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Monitoring & Logging                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Prometheus  │  │   Grafana    │  │  ELK Stack   │          │
│  │  (Scraping)  │  │ (Dashboard)  │  │  (Logs)      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     Target Databases                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ PostgreSQL   │  │    MySQL     │  │  OceanBase   │          │
│  │   Cluster    │  │   Cluster    │  │   Cluster    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘

部署特点:
- 水平扩展: 多个应用实例负载均衡
- 无状态设计: 应用实例可随意增减
- 分布式缓存: Redis集群共享缓存
- 异步任务: RabbitMQ消息队列
- 监控完善: Prometheus + Grafana + ELK
```

## 5. 数据模型关系图

```
┌─────────────────────┐
│  DatabaseInstance   │
│─────────────────────│
│  id                 │◀────────┐
│  name               │         │
│  type               │         │
│  host               │         │
│  port               │         │
└─────────────────────┘         │
                                │  FK
┌─────────────────────┐         │
│  LockEvent          │─────────┘
│─────────────────────│
│  id                 │
│  database_id        │───────┐
│  lock_type          │       │
│  lock_mode          │       │
│  object_name        │       │
│  session_id         │       │
│  wait_duration      │       │
│  query_text         │       │
│  timestamp          │       │
└─────────────────────┘       │
                              │
                              │  Used for
                              │  Analysis
┌─────────────────────┐       │
│  LockWaitChain      │───────┤
│─────────────────────│       │
│  id                 │       │
│  database_id        │       │
│  chain_id           │       │
│  chain_length       │       │
│  total_wait_time    │       │
│  severity_level     │       │
│  chain_details(JSON)│       │
└─────────────────────┘       │
                              │
┌─────────────────────┐       │
│  LockContention     │───────┤
│─────────────────────│       │
│  id                 │       │
│  database_id        │       │
│  object_name        │       │
│  contention_count   │       │
│  total_wait_time    │       │
│  contention_pattern │       │
│  priority_level     │       │
└─────────────────────┘       │
                              │
┌─────────────────────┐       │
│  AnalysisReport     │───────┘
│─────────────────────│
│  id                 │
│  database_id        │
│  health_score       │
│  report_content(JSON)│
│  recommendations(JSON)│
│  timestamp          │
└─────────────────────┘

索引策略:
- (database_id, timestamp) - 按时间范围查询
- (object_name, timestamp) - 按对象查询
- (severity_level) - 按严重程度过滤
- (contention_pattern) - 按模式分类
```

---

这些架构图展示了锁分析模块的完整技术架构，从整体视图到具体组件交互，帮助理解系统设计和实现。